# バトルシステム実装計画

## 概要

flutter を使用したシンプルなコマンドバトルゲームのバトルシステムを実装する。
三すくみの関係を持つコマンド（攻・反・溜）のじゃんけんを繰り返し、相手のHPを0にした方が勝利となる。

## 現在の状況

- Flutter プロジェクト基盤は構築済み
- Isar（ローカルDB）、freezed が依存関係に追加済み
- Flavorizr による環境分けが設定済み
- 基本的なアプリ構造（App, MyHomePage）が存在する
    - 最終的にはトップメニューとバトル画面の２画面構成になる予定

## 実装計画

### Phase 1: データモデル設計・実装

- [ ] キャラクターデータモデルの作成
    - [ ] `lib/models/character.dart` - キャラクター基本情報
    - [ ] `lib/models/character.freezed.dart` - freezed生成ファイル
- [ ] バトル関連データモデルの作成
    - [ ] `lib/models/battle_command.dart` - コマンド（攻・反・溜・必殺技）定義
    - [ ] `lib/models/battle_state.dart` - バトル状態管理（溜め、防御、無防備、行動不能状態含む）
    - [ ] `lib/models/battle_result.dart` - バトル結果
    - [ ] `lib/models/character_skill.dart` - 必殺技・特性・連勝ボーナス定義
    - [ ] `lib/models/status_effect.dart` - 状態異常・バフ・デバフ定義
- [ ] Isarデータベースエンティティの作成
    - [ ] `lib/database/entities/player_entity.dart` - プレイヤーデータ
    - [ ] `lib/database/entities/enemy_entity.dart` - 敵データ

### Phase 2: バトルロジック実装

- [ ] 三すくみシステムの実装
    - [ ] `lib/game/battle_logic.dart` - じゃんけん判定ロジック
    - [ ] コマンド相性判定（攻 > 反 > 溜 > 攻）
- [ ] コマンド制限システムの実装
    - [ ] 連続同一コマンド制限（2回連続後は選択不可）
    - [ ] コマンド履歴管理
- [ ] ダメージ計算システムの実装
    - [ ] 基本ダメージ計算
    - [ ] HP管理
    - [ ] 勝敗判定
- [ ] 必殺技システムの実装
    - [ ] 溜め状態による必殺技の解放ロジック
    - [ ] 必殺技コマンドの効果処理
    - [ ] 必殺技使用後の攻コマンド復帰処理
- [ ] 状態管理システムの実装
    - [ ] 溜め状態（レベル1-4）の管理
    - [ ] 防御・無防備・行動不能状態の処理
    - [ ] 状態の継続・解除ロジック
- [ ] 特性・連勝ボーナスシステムの実装
    - [ ] キャラクター固有特性の効果処理
    - [ ] 連勝ボーナスの発動条件・効果処理

### Phase 3: バトルUI実装

- [ ] バトル画面の作成
    - [ ] `lib/pages/battle_page.dart` - メインバトル画面
    - [ ] キャラクター表示UI
    - [ ] HP表示UI
- [ ] コマンド選択UI実装
    - [ ] コマンドボタン（攻・反・溜・必殺技）
    - [ ] 使用不可コマンドの視覚的表示
    - [ ] 必殺技ボタンの溜め状態による表示切り替え
- [ ] 状態表示UI実装
    - [ ] 溜め状態レベル表示
    - [ ] 防御・無防備・行動不能状態の表示
    - [ ] キャラクター特性・連勝ボーナス状態の表示
- [ ] バトル結果表示UI
    - [ ] ターン結果表示
    - [ ] 最終勝敗表示

### Phase 4: 状態管理実装

- [ ] BLoC/Riverpodによる状態管理
    - [ ] `lib/blocs/battle_bloc.dart` - バトル状態管理
    - [ ] バトルイベント定義
    - [ ] バトル状態更新ロジック
- [ ] データ永続化
    - [ ] Isarデータベース設定
    - [ ] バトル履歴保存機能

### Phase 5: テストデータ・初期化

- [ ] テストデータの実装
    - [ ] プレイヤーキャラクター(sordian)初期データ
        - [ ] 基本パラメータ（HP:100, 攻撃:10, 防御:8, 回復:5）
        - [ ] 連勝ボーナス「ハイテンション」
        - [ ] 特性「お調子者」
        - [ ] 必殺技1-3の効果定義
    - [ ] 敵キャラクター(samurai)初期データ
        - [ ] 基本パラメータ（HP:90, 攻撃:8, 防御:5, 回復:6）
        - [ ] 連勝ボーナス「技巧派」
        - [ ] 特性「華麗な剣技」
        - [ ] 必殺技1-3の効果定義
- [ ] データベース初期化処理
    - [ ] アプリ起動時のデータベースセットアップ

### Phase 6: 高度なゲームメカニクス実装

- [ ] AI敵キャラクターの実装
    - [ ] 基本的なランダム選択AI
    - [ ] プレイヤーの行動パターンを考慮したAI（将来拡張用）
- [ ] バトルアニメーション・エフェクト
    - [ ] ダメージ表示アニメーション
    - [ ] 状態変化エフェクト
    - [ ] 必殺技使用時の特殊エフェクト

### Phase 7: 統合・テスト

- [ ] 各コンポーネントの統合
- [ ] バトルフロー全体のテスト
- [ ] 特性・連勝ボーナス・必殺技の動作確認
- [ ] UI/UXの調整

## 技術スタック

- **フレームワーク**: Flutter (最新)
- **状態管理**: BLoC or Riverpod
- **データモデル**: freezed
- **ローカルDB**: Isar
- **環境管理**: Flavorizr

## ファイル構成予定

```bash
lib/
├── models/
│   ├── character.dart
│   ├── battle_command.dart
│   ├── battle_state.dart
│   ├── battle_result.dart
│   ├── character_skill.dart
│   └── status_effect.dart
├── database/
│   ├── database.dart
│   └── entities/
│       ├── player_entity.dart
│       └── enemy_entity.dart
├── game/
│   ├── battle_logic.dart
│   ├── skill_processor.dart
│   └── status_manager.dart
├── blocs/
│   └── battle_bloc.dart
├── pages/
│   ├── battle_page.dart
│   └── my_home_page.dart (既存)
└── widgets/
    ├── character_display.dart
    ├── command_buttons.dart
    ├── status_display.dart
    └── battle_result_dialog.dart
```

## 実装時の注意点

- YAGNI原則に従い、現在の要件に集中する
- DRY原則で重複コードは関数化・モジュール化する
- KISS原則でシンプルで理解しやすいコードを心がける
- 小さな単位でコードを生成し、逐次レビューを行う

## 重要なゲーム仕様

- **連続コマンド制限**: 2回連続同じコマンド使用後、次ターンでそのコマンドは使用不可
- **必殺技システム**: 溜め状態のレベルに応じて使用可能な必殺技が増加
- **状態管理**: 溜め(1-4)、防御、無防備、行動不能状態の適切な処理
- **特性効果**: キャラクター固有の常時効果の正確な実装
- **連勝ボーナス**: 2回連続勝利時の特殊効果（あいこを挟むと無効）
